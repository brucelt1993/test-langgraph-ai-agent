FROM node:20-alpine

# 安装Playwright依赖
RUN apk add --no-cache \
    chromium \
    firefox \
    webkit \
    && rm -rf /var/cache/apk/*

# 设置工作目录
WORKDIR /app

# 复制package文件
COPY package*.json ./

# 安装依赖
RUN npm ci

# 安装Playwright浏览器
RUN npx playwright install --with-deps

# 复制测试文件
COPY . .

# 编译TypeScript
RUN npx tsc

# 设置环境变量
ENV PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
ENV NODE_ENV=test

# 运行测试
CMD ["npx", "playwright", "test", "--reporter=html,json,junit"]